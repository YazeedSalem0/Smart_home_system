{% extends "base.html" %}

{% block title %}Dashboard - Smart Home System{% endblock %}

{% block content %}
<div class="row">
    <!-- System Status Overview -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>System Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-thermometer-half fa-2x text-danger me-3"></i>
                            <div>
                                <h6 class="mb-0">Temperature</h6>
                                <span id="temperature" class="h4 text-danger">--°C</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tint fa-2x text-info me-3"></i>
                            <div>
                                <h6 class="mb-0">Humidity</h6>
                                <span id="humidity" class="h4 text-info">--%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-fan fa-2x text-success me-3"></i>
                            <div>
                                <h6 class="mb-0">Fans</h6>
                                <span id="fan-status" class="h4">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                            <div>
                                <h6 class="mb-0">Gas Detection</h6>
                                <span id="gas-status" class="h4">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Motion Detection -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-walking me-2"></i>Motion Detection</h5>
            </div>
            <div class="card-body">
                <div class="row" id="motion-sensors">
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator me-2" id="motion-Room1"></span>
                            <span>Room 1</span>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator me-2" id="motion-Room2"></span>
                            <span>Room 2</span>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator me-2" id="motion-Room3"></span>
                            <span>Room 3</span>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator me-2" id="motion-LivingRoom"></span>
                            <span>Living Room</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Status -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Security Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-door-closed me-2"></i>Door Lock</span>
                            <span id="door-status" class="badge">--</span>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-warehouse me-2"></i>Garage Door</span>
                            <span id="garage-status" class="badge">--</span>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-user-check me-2"></i>Face Recognition</span>
                            <span id="face-status" class="badge">--</span>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-exclamation-circle me-2"></i>Emergency Mode</span>
                            <span id="emergency-status" class="badge">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lighting Status -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Lighting Status</h5>
            </div>
            <div class="card-body">
                <div class="row" id="lighting-status">
                    <div class="col-6 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Room 1</span>
                            <div class="light-indicator" id="light-Room1">
                                <span class="light-color" style="background-color: #000;"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Room 2</span>
                            <div class="light-indicator" id="light-Room2">
                                <span class="light-color" style="background-color: #000;"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Room 3</span>
                            <div class="light-indicator" id="light-Room3">
                                <span class="light-color" style="background-color: #000;"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Living Room</span>
                            <div class="light-indicator" id="light-LivingRoom">
                                <span class="light-color" style="background-color: #000;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-2">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="toggleAllLights()">
                            <i class="fas fa-lightbulb me-1"></i>Toggle All Lights
                        </button>
                    </div>
                    <div class="col-6 mb-2">
                        <button class="btn btn-outline-success btn-sm w-100" onclick="toggleFans()">
                            <i class="fas fa-fan me-1"></i>Toggle Fans
                        </button>
                    </div>
                    <div class="col-6 mb-2">
                        <button class="btn btn-outline-warning btn-sm w-100" onclick="toggleDoor()">
                            <i class="fas fa-door-open me-1"></i>Toggle Door
                        </button>
                    </div>
                    <div class="col-6 mb-2">
                        <button class="btn btn-outline-info btn-sm w-100" onclick="toggleGarage()">
                            <i class="fas fa-warehouse me-1"></i>Toggle Garage
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h5>
            </div>
            <div class="card-body">
                <div id="activity-log" class="activity-log">
                    <p class="text-muted">Loading activity...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Dashboard-specific JavaScript
let activityLog = [];

function updateDashboard(data) {
    // Update temperature and humidity
    $('#temperature').text(data.temperature ? data.temperature.toFixed(1) + '°C' : '--°C');
    $('#humidity').text(data.humidity ? data.humidity.toFixed(1) + '%' : '--%');
    
    // Update fan status
    $('#fan-status').text(data.fans_on ? 'ON' : 'OFF')
                   .removeClass('text-success text-danger')
                   .addClass(data.fans_on ? 'text-success' : 'text-danger');
    
    // Update gas status
    $('#gas-status').text(data.gas_detected ? 'DETECTED' : 'CLEAR')
                   .removeClass('text-danger text-success')
                   .addClass(data.gas_detected ? 'text-danger' : 'text-success');
    
    // Update motion sensors
    if (data.motion) {
        Object.keys(data.motion).forEach(room => {
            const indicator = $('#motion-' + room);
            indicator.removeClass('bg-success bg-secondary')
                    .addClass(data.motion[room] ? 'bg-success' : 'bg-secondary');
        });
    }
    
    // Update security status
    $('#door-status').text(data.door_locked ? 'LOCKED' : 'UNLOCKED')
                    .removeClass('bg-success bg-danger')
                    .addClass(data.door_locked ? 'bg-success' : 'bg-danger');
    
    $('#garage-status').text(data.garage_door_open ? 'OPEN' : 'CLOSED')
                      .removeClass('bg-warning bg-success')
                      .addClass(data.garage_door_open ? 'bg-warning' : 'bg-success');
    
    $('#face-status').text(data.face_recognized ? 'RECOGNIZED' : 'NO FACE')
                    .removeClass('bg-success bg-secondary')
                    .addClass(data.face_recognized ? 'bg-success' : 'bg-secondary');
    
    $('#emergency-status').text(data.emergency_mode ? 'ACTIVE' : 'NORMAL')
                         .removeClass('bg-danger bg-success')
                         .addClass(data.emergency_mode ? 'bg-danger' : 'bg-success');
}

// Quick action functions
function toggleAllLights() {
    // Implementation for toggling all lights
    console.log('Toggle all lights');
}

function toggleFans() {
    $.post('/api/control/fan', {
        action: 'toggle'
    }).done(function(response) {
        if (response.success) {
            addActivity('Fans toggled manually');
        }
    });
}

function toggleDoor() {
    $.post('/api/control/door', {
        action: 'toggle'
    }).done(function(response) {
        if (response.success) {
            addActivity('Door lock toggled manually');
        }
    });
}

function toggleGarage() {
    $.post('/api/control/garage', {
        action: 'toggle'
    }).done(function(response) {
        if (response.success) {
            addActivity('Garage door toggled manually');
        }
    });
}

function addActivity(message) {
    const timestamp = new Date().toLocaleTimeString();
    activityLog.unshift(`${timestamp}: ${message}`);
    
    // Keep only last 10 activities
    if (activityLog.length > 10) {
        activityLog = activityLog.slice(0, 10);
    }
    
    updateActivityLog();
}

function updateActivityLog() {
    const logHtml = activityLog.map(activity => 
        `<div class="activity-item">${activity}</div>`
    ).join('');
    
    $('#activity-log').html(logHtml || '<p class="text-muted">No recent activity</p>');
}

// Initialize dashboard
$(document).ready(function() {
    // Set up real-time updates
    if (typeof updateSystemData === 'function') {
        const originalUpdate = updateSystemData;
        updateSystemData = function(data) {
            originalUpdate(data);
            updateDashboard(data);
        };
    }
});
</script>
{% endblock %} 